<section
  class="max-w-[1200px] p-8 bg-[var(--card)] rounded-3xl border border-[var(--glass-border)] shadow-2xl text-[var(--text)] animate-[fadeIn_0.4s_ease-out] md:p-5 mx-auto max-[400px]:p-3"
  *ngIf="group; else loadingOrError">
  <header class="flex flex-col gap-6 mb-10 pb-8 border-b border-[var(--glass-border)]">
    <div>
      <p class="uppercase tracking-[0.15em] text-xs font-semibold text-[var(--primary)]">Class overview</p>
      <h1
        class="text-[2.5rem] font-extrabold my-2 bg-gradient-to-br from-[var(--text)] to-[var(--muted)] bg-clip-text text-transparent md:text-3xl max-[400px]:text-2xl">
        {{ group.name }}</h1>
      <p class="text-[var(--muted)] text-lg leading-relaxed max-[400px]:text-base">{{ group.description || 'No
        description provided.' }}</p>
    </div>
    <div class="flex gap-4 mt-4 md:flex-col md:w-full" *ngIf="canManageGroup">
      <button
        class="bg-gradient-to-br from-[var(--primary)] to-[#7c3aed] text-white rounded-full px-6 py-2.5 shadow-lg hover:-translate-y-0.5 hover:brightness-110 transition-all font-semibold justify-center"
        type="button" (click)="openLessonForm()">Add Lesson</button>
    </div>
    <div
      class="grid grid-cols-[repeat(auto-fit,minmax(220px,1fr))] gap-6 mt-4 md:grid-cols-2 sm:grid-cols-1 max-[350px]:grid-cols-1">
      <div
        class="p-5 border border-[var(--glass-border)] rounded-2xl bg-[var(--glass)] hover:-translate-y-0.5 hover:shadow-md transition-all">
        <p class="text-xs uppercase tracking-widest text-[var(--muted)] mb-2 block">Subject</p>
        <span class="text-lg font-semibold text-[var(--text)]">{{ group.subject || 'General' }}</span>
      </div>
      <div
        class="p-5 border border-[var(--glass-border)] rounded-2xl bg-[var(--glass)] hover:-translate-y-0.5 hover:shadow-md transition-all">
        <p class="text-xs uppercase tracking-widest text-[var(--muted)] mb-2 block">Teacher</p>
        <span class="text-lg font-semibold text-[var(--text)]">{{ group.teacher?.name || 'Unassigned' }}</span>
      </div>
      <div
        class="p-5 border border-[var(--glass-border)] rounded-2xl bg-[var(--glass)] hover:-translate-y-0.5 hover:shadow-md transition-all">
        <p class="text-xs uppercase tracking-widest text-[var(--muted)] mb-2 block">Center</p>
        <span class="text-lg font-semibold text-[var(--text)]">{{ group.center?.name || 'N/A' }}</span>
      </div>
      <div
        class="p-5 border border-[var(--glass-border)] rounded-2xl bg-[var(--glass)] hover:-translate-y-0.5 hover:shadow-md transition-all">
        <p class="text-xs uppercase tracking-widest text-[var(--muted)] mb-2 block">Schedule</p>
        <span class="text-lg font-semibold text-[var(--text)]">{{ scheduleLabel }}</span>
      </div>
    </div>
  </header>

  <!-- Mobile View Toggle -->
  <div class="flex p-1 bg-[var(--glass)] border border-[var(--glass-border)] rounded-xl mb-6 lg:hidden">
    <button class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all"
      [class.bg-[var(--card)]]="viewMode === 'students'" [class.shadow-sm]="viewMode === 'students'"
      [class.text-[var(--primary)]]="viewMode === 'students'" [class.text-[var(--muted)]]="viewMode !== 'students'"
      (click)="setViewMode('students')">
      Students
    </button>
    <button class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all"
      [class.bg-[var(--card)]]="viewMode === 'lessons'" [class.shadow-sm]="viewMode === 'lessons'"
      [class.text-[var(--primary)]]="viewMode === 'lessons'" [class.text-[var(--muted)]]="viewMode !== 'lessons'"
      (click)="setViewMode('lessons')">
      Lessons
    </button>
  </div>

  <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
    <section
      class="border border-[var(--glass-border)] rounded-[1.25rem] bg-[var(--card)] shadow-sm p-6 min-h-[300px] flex flex-col overflow-x-auto max-[400px]:p-4 lg:flex"
      [class.hidden]="viewMode !== 'students'">
      <header class="flex justify-between items-center mb-6 pb-4 border-b border-[var(--glass-border)]">
        <h2 class="text-xl font-bold m-0 text-[var(--text)]">Students</h2>
        <div class="flex items-center gap-3">
          <button *ngIf="canManageGroup"
            class="w-8 h-8 rounded-full bg-[var(--primary)] text-white flex items-center justify-center shadow-lg hover:scale-110 transition-transform"
            (click)="openAddStudentPanel()" title="Add Student">
            <i class="fas fa-plus text-sm"></i>
          </button>
          <span
            class="px-3 py-1 rounded-full bg-[var(--glass)] border border-[var(--glass-border)] text-sm font-semibold text-[var(--primary)]">{{
            students.length }}</span>
        </div>
      </header>
      <div *ngIf="loadingStudents"
        class="p-12 rounded-2xl bg-[var(--glass)] border-2 border-dashed border-[var(--glass-border)] text-[var(--muted)] text-center text-base">
        Loading students...</div>
      <div *ngIf="!loadingStudents && !students.length"
        class="p-12 rounded-2xl bg-[var(--glass)] border-2 border-dashed border-[var(--glass-border)] text-[var(--muted)] text-center text-base">
        No students assigned.</div>
      <div *ngIf="students.length" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <article *ngFor="let student of students"
          class="p-4 bg-[var(--glass)] border border-[var(--glass-border)] rounded-xl text-[var(--text)] cursor-pointer hover:bg-white/5 hover:border-[var(--primary)] transition-all flex justify-between items-center"
          (click)="openStudentPanel(student)">
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
              {{ student.name.charAt(0).toUpperCase() }}
            </div>
            <span class="font-semibold text-base">{{ student.name }}</span>
          </div>
          <i class="fas fa-chevron-right text-[var(--muted)] text-sm"></i>
        </article>
      </div>

      <!-- Students Pagination -->
      <div class="flex justify-center items-center gap-4 mt-4 text-sm max-[400px]:flex-col"
        *ngIf="studentsMeta && studentsMeta.last_page > 1">
        <button (click)="changeStudentPage(studentsMeta.current_page - 1)" [disabled]="studentsMeta.current_page === 1"
          class="px-3 py-1 rounded-lg border border-[var(--glass-border)] bg-[var(--glass)] hover:bg-[var(--primary)] hover:text-white disabled:opacity-50 disabled:hover:bg-[var(--glass)] disabled:hover:text-[var(--text)] transition-all">
          Previous
        </button>
        <span class="text-[var(--muted)]">Page {{ studentsMeta.current_page }} of {{ studentsMeta.last_page }}</span>
        <button (click)="changeStudentPage(studentsMeta.current_page + 1)"
          [disabled]="studentsMeta.current_page === studentsMeta.last_page"
          class="px-3 py-1 rounded-lg border border-[var(--glass-border)] bg-[var(--glass)] hover:bg-[var(--primary)] hover:text-white disabled:opacity-50 disabled:hover:bg-[var(--glass)] disabled:hover:text-[var(--text)] transition-all">
          Next
        </button>
      </div>
    </section>

    <section
      class="border border-[var(--glass-border)] rounded-[1.25rem] bg-[var(--card)] shadow-sm p-6 min-h-[300px] flex flex-col overflow-x-auto max-[400px]:p-4 lg:flex"
      [class.hidden]="viewMode !== 'lessons'">
      <header class="flex justify-between items-center mb-6 pb-4 border-b border-[var(--glass-border)]">
        <h2 class="text-xl font-bold m-0 text-[var(--text)]">Lessons</h2>
        <span
          class="px-3 py-1 rounded-full bg-[var(--glass)] border border-[var(--glass-border)] text-sm font-semibold text-[var(--primary)]">{{
          lessonsMeta?.total || lessons.length }}</span>
      </header>
      <div *ngIf="loadingLessons"
        class="p-12 rounded-2xl bg-[var(--glass)] border-2 border-dashed border-[var(--glass-border)] text-[var(--muted)] text-center text-base">
        Loading lessons...</div>
      <div *ngIf="!loadingLessons && !lessons.length"
        class="p-12 rounded-2xl bg-[var(--glass)] border-2 border-dashed border-[var(--glass-border)] text-[var(--muted)] text-center text-base">
        No lessons scheduled.</div>
      <ul *ngIf="lessons.length" class="list-none m-0 p-0 flex flex-col gap-4">
        <li *ngFor="let lesson of lessons"
          class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between p-4 bg-[var(--glass)] border border-[var(--glass-border)] rounded-xl transition-all hover:translate-x-1 hover:border-[var(--primary)]">
          <div>
            <p class="font-semibold m-0 text-base text-[var(--text)]">{{ lesson.title }}</p>
            <p class="text-[var(--muted)] text-[0.95rem]">{{ lesson.scheduled_at ? (lesson.scheduled_at | date:'medium')
              : 'Not scheduled' }}</p>
          </div>
          <div class="flex flex-col gap-2 sm:items-end sm:text-right w-full sm:w-auto">
            <span
              class="px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-xs font-medium text-indigo-500 self-start sm:self-end">{{
              lesson.resources_count }} resources</span>
            <button type="button"
              class="bg-[var(--card)] border border-[var(--glass-border)] px-4 py-1.5 rounded-full text-sm font-semibold text-[var(--text)] hover:border-[var(--primary)] hover:-translate-y-0.5 transition-all w-full sm:w-auto"
              (click)="viewLesson(lesson.id)">
              Open
            </button>
          </div>
        </li>
      </ul>

      <!-- Lessons Pagination -->
      <div class="flex justify-center items-center gap-4 mt-4 text-sm max-[400px]:flex-col"
        *ngIf="lessonsMeta && lessonsMeta.last_page > 1">
        <button (click)="changeLessonPage(lessonsMeta.current_page - 1)" [disabled]="lessonsMeta.current_page === 1"
          class="px-3 py-1 rounded-lg border border-[var(--glass-border)] bg-[var(--glass)] hover:bg-[var(--primary)] hover:text-white disabled:opacity-50 disabled:hover:bg-[var(--glass)] disabled:hover:text-[var(--text)] transition-all">
          Previous
        </button>
        <span class="text-[var(--muted)]">Page {{ lessonsMeta.current_page }} of {{ lessonsMeta.last_page }}</span>
        <button (click)="changeLessonPage(lessonsMeta.current_page + 1)"
          [disabled]="lessonsMeta.current_page === lessonsMeta.last_page"
          class="px-3 py-1 rounded-lg border border-[var(--glass-border)] bg-[var(--glass)] hover:bg-[var(--primary)] hover:text-white disabled:opacity-50 disabled:hover:bg-[var(--glass)] disabled:hover:text-[var(--text)] transition-all">
          Next
        </button>
      </div>
    </section>

  </div>
</section>

<ng-template #loadingOrError>
  <div
    class="p-12 rounded-2xl bg-[var(--glass)] border-2 border-dashed border-[var(--glass-border)] text-[var(--muted)] text-center text-base"
    *ngIf="loadingGroup">Loading group...</div>
  <div
    class="p-12 rounded-2xl bg-[var(--glass)] border-2 border-dashed border-[var(--glass-border)] text-[var(--muted)] text-center text-base"
    *ngIf="!loadingGroup">{{ errorMessage || 'Group not found.' }}</div>
</ng-template>

<!-- Lesson Side Panel -->
<div class="fixed inset-0 bg-black/20 opacity-0 pointer-events-none transition-opacity duration-250"
  [class.opacity-100]="panelOpen" [class.pointer-events-auto]="panelOpen" (click)="closePanel()"></div>

<div
  class="fixed inset-y-0 right-0 w-[min(420px,90vw)] max-[640px]:w-full bg-[var(--card)] border-l border-[var(--glass-border)] shadow-[-8px_0_24px_rgba(0,0,0,0.18)] transition-transform duration-300 p-5 flex flex-col gap-3.5 z-[999]"
  [ngClass]="panelOpen ? 'translate-x-0' : 'translate-x-full'" (click)="$event.stopPropagation()">

  <div class="flex justify-between items-center font-bold">
    <h3 class="m-0 text-xl">{{ panelTitle }}</h3>
    <button
      class="border-none bg-transparent text-2xl cursor-pointer text-[var(--text)] hover:text-[var(--primary)] transition-colors"
      type="button" (click)="closePanel()">X</button>
  </div>

  <div class="flex flex-col gap-5 flex-1 overflow-y-auto pb-4" *ngIf="panelMode === 'lesson'">
    <div class="block">
      <label class="block mb-2 text-sm font-medium text-[var(--muted)]">Title <span
          class="text-red-500">*</span></label>
      <input
        class="w-full px-4 py-3 rounded-xl border border-[var(--glass-border)] bg-white/5 text-[var(--text)] shadow-inner focus:outline-none focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)]/20 transition-all text-[0.95rem]"
        [class.border-red-500]="lessonErrors.title" type="text" [(ngModel)]="lessonForm.title"
        placeholder="Lesson title" (ngModelChange)="onLessonInputChange('title')" />
      <p class="text-sm text-red-500 mt-1" *ngIf="lessonErrors.title">{{ lessonErrors.title }}</p>
    </div>
    <div class="block">
      <label class="block mb-2 text-sm font-medium text-[var(--muted)]">Description <span
          class="text-red-500">*</span></label>
      <textarea
        class="w-full px-4 py-3 rounded-xl border border-[var(--glass-border)] bg-white/5 text-[var(--text)] shadow-inner focus:outline-none focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)]/20 transition-all text-[0.95rem]"
        [class.border-red-500]="lessonErrors.description" [(ngModel)]="lessonForm.description" rows="3"
        placeholder="Optional description" (ngModelChange)="onLessonInputChange('description')"></textarea>
      <p class="text-sm text-red-500 mt-1" *ngIf="lessonErrors.description">{{ lessonErrors.description }}</p>
    </div>
    <div class="block">
      <label class="block mb-2 text-sm font-medium text-[var(--muted)]">Scheduled at <span
          class="text-red-500">*</span></label>
      <input
        class="w-full px-4 py-3 rounded-xl border border-[var(--glass-border)] bg-white/5 text-[var(--text)] shadow-inner focus:outline-none focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)]/20 transition-all text-[0.95rem]"
        [class.border-red-500]="lessonErrors.scheduled_at" type="datetime-local" [(ngModel)]="lessonForm.scheduled_at"
        [min]="minDateTime" (ngModelChange)="onLessonInputChange('scheduled_at')" />
      <p class="text-sm text-red-500 mt-1" *ngIf="lessonErrors.scheduled_at">{{ lessonErrors.scheduled_at }}</p>
    </div>
    <p class="text-sm text-red-500 m-0" *ngIf="lessonError">{{ lessonError }}</p>
    <div
      class="mt-auto sticky bottom-0 pt-4 bg-gradient-to-t from-[var(--card)] via-[var(--card)] to-transparent border-t border-[var(--glass-border)] flex justify-end">
      <button
        class="bg-gradient-to-br from-[var(--primary)] to-[#7c3aed] text-white rounded-full px-6 py-2.5 shadow-lg hover:-translate-y-0.5 hover:brightness-110 transition-all font-semibold disabled:opacity-60 disabled:cursor-not-allowed disabled:grayscale-[0.5]"
        type="button" (click)="submitLesson()" [disabled]="processing || !lessonFormValid">Create Lesson</button>
    </div>
  </div>

</div>

<!-- Student Side Panel -->
<div class="fixed inset-0 bg-black/20 opacity-0 pointer-events-none transition-opacity duration-250"
  [class.opacity-100]="studentPanelOpen" [class.pointer-events-auto]="studentPanelOpen" (click)="closeStudentPanel()">
</div>

<div
  class="fixed inset-y-0 right-0 w-[min(420px,90vw)] max-[640px]:w-full bg-[var(--card)] border-l border-[var(--glass-border)] shadow-[-8px_0_24px_rgba(0,0,0,0.18)] transition-transform duration-300 p-5 flex flex-col gap-3.5 z-[999]"
  [ngClass]="studentPanelOpen ? 'translate-x-0' : 'translate-x-full'" (click)="$event.stopPropagation()"
  *ngIf="selectedStudent">

  <div class="flex justify-between items-center font-bold">
    <h3 class="m-0 text-xl">Student Details</h3>
    <button
      class="border-none bg-transparent text-2xl cursor-pointer text-[var(--text)] hover:text-[var(--primary)] transition-colors"
      type="button" (click)="closeStudentPanel()">X</button>
  </div>

  <div class="flex flex-col gap-6 flex-1 overflow-y-auto pb-4">
    <div class="flex flex-col items-center gap-3 py-4">
      <div
        class="w-20 h-20 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-3xl shadow-lg">
        {{ selectedStudent.name.charAt(0).toUpperCase() }}
      </div>
      <div class="text-center">
        <h2 class="text-xl font-bold m-0">{{ selectedStudent.name }}</h2>
        <p class="text-[var(--muted)] text-sm mt-1">{{ selectedStudent.email }}</p>
      </div>
    </div>

    <div class="p-4 rounded-xl bg-[var(--glass)] border border-[var(--glass-border)] flex flex-col gap-3">
      <div class="flex justify-between items-center">
        <span class="text-sm text-[var(--muted)]">Status</span>
        <span
          class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 uppercase tracking-wide">
          {{ selectedStudent.status }}
        </span>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-sm text-[var(--muted)]">Joined</span>
        <span class="text-sm font-medium">{{ selectedStudent.joined_at ? (selectedStudent.joined_at | date:'mediumDate')
          : 'â€”' }}</span>
      </div>
    </div>
    
    <div class="p-4 rounded-xl bg-[var(--glass)] border border-[var(--glass-border)] flex flex-col gap-3" *ngIf="selectedStudent.parents && selectedStudent.parents.length > 0">
      <h4 class="text-sm font-semibold text-[var(--muted)] uppercase tracking-wider m-0">Parent / Guardian</h4>
      <div *ngFor="let parent of selectedStudent.parents" class="flex flex-col gap-1 pb-2 border-b border-[var(--glass-border)] last:border-0 last:pb-0">
        <span class="text-[var(--text)] font-semibold">{{ parent.name }}</span>
        <span class="text-[var(--muted)] text-sm">{{ parent.email }}</span>
        <span class="text-[var(--muted)] text-sm" *ngIf="parent.phone">{{ parent.phone }}</span>
      </div>
    </div>
    <div class="p-4 rounded-xl bg-[var(--glass)] border border-[var(--glass-border)]" *ngIf="!selectedStudent.parents || selectedStudent.parents.length === 0">
       <h4 class="text-sm font-semibold text-[var(--muted)] uppercase tracking-wider m-0 mb-1">Parent / Guardian</h4>
       <span class="text-[var(--muted)] italic text-sm">No parent linked</span>
    </div>

    <div
      class="mt-auto sticky bottom-0 pt-4 bg-gradient-to-t from-[var(--card)] via-[var(--card)] to-transparent border-t border-[var(--glass-border)] flex flex-col gap-3"
      *ngIf="canManageGroup">
      <button
        class="w-full bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl px-4 py-3 font-semibold hover:bg-red-500/20 transition-all flex items-center justify-center gap-2"
        type="button" (click)="removeStudentFromGroup()" [disabled]="processing">
        <i class="fas fa-user-minus"></i>
        Remove from Group
      </button>
      <p class="text-xs text-[var(--muted)] text-center px-4">
        This will remove the student from this group only. Their account will remain active in the center.
      </p>
    </div>
  </div>
</div>

<!-- Add Student Side Panel -->
<div class="fixed inset-0 bg-black/20 opacity-0 pointer-events-none transition-opacity duration-250"
  [class.opacity-100]="addStudentPanelOpen" [class.pointer-events-auto]="addStudentPanelOpen"
  (click)="closeAddStudentPanel()">
</div>

<div
  class="fixed inset-y-0 right-0 w-[min(420px,90vw)] max-[640px]:w-full bg-[var(--card)] border-l border-[var(--glass-border)] shadow-[-8px_0_24px_rgba(0,0,0,0.18)] transition-transform duration-300 p-5 flex flex-col gap-3.5 z-[999]"
  [ngClass]="addStudentPanelOpen ? 'translate-x-0' : 'translate-x-full'" (click)="$event.stopPropagation()">

  <div class="flex justify-between items-center font-bold">
    <h3 class="m-0 text-xl">Add Student to Group</h3>
    <button
      class="border-none bg-transparent text-2xl cursor-pointer text-[var(--text)] hover:text-[var(--primary)] transition-colors"
      type="button" (click)="closeAddStudentPanel()">X</button>
  </div>

  <div class="flex flex-col gap-4 flex-1 overflow-y-auto pb-4">
    <div class="relative">
      <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-[var(--muted)]"></i>
      <input
        class="w-full pl-10 pr-4 py-3 rounded-xl border border-[var(--glass-border)] bg-white/5 text-[var(--text)] shadow-inner focus:outline-none focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--primary)]/20 transition-all text-[0.95rem]"
        type="text" placeholder="Search students by name or email..." [ngModel]="studentSearchTerm"
        (ngModelChange)="onStudentSearchChange($event)" />
    </div>

    <div class="flex flex-col gap-2 mt-2" *ngIf="searchedStudents.length > 0; else noResults">
      <div *ngFor="let student of searchedStudents"
        class="flex items-center justify-between p-3 rounded-xl bg-[var(--glass)] border border-[var(--glass-border)] hover:border-[var(--primary)] transition-colors">
        <div class="flex items-center gap-3 overflow-hidden">
          <div
            class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex-shrink-0 flex items-center justify-center text-white font-bold text-sm">
            {{ student.avatar }}
          </div>
          <div class="flex flex-col overflow-hidden">
            <span class="font-semibold text-[var(--text)] truncate">{{ student.name }}</span>
            <span class="text-xs text-[var(--muted)] truncate">{{ student.email }}</span>
          </div>
        </div>
        <button
          class="px-3 py-1.5 rounded-lg bg-[var(--primary)] text-white text-sm font-medium shadow-md hover:brightness-110 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="addStudentToGroup(student)" [disabled]="addingStudent">
          Add
        </button>
      </div>
    </div>

    <ng-template #noResults>
      <div class="flex flex-col items-center justify-center py-10 text-[var(--muted)]" *ngIf="studentSearchTerm">
        <i class="fas fa-user-slash text-3xl mb-3 opacity-50"></i>
        <p>No students found matching "{{ studentSearchTerm }}"</p>
      </div>
      <div class="flex flex-col items-center justify-center py-10 text-[var(--muted)]" *ngIf="!studentSearchTerm">
        <i class="fas fa-search text-3xl mb-3 opacity-50"></i>
        <p>Type to search for students</p>
      </div>
    </ng-template>
  </div>
</div>