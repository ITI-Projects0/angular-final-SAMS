<section class="list-wrapper">
  <header class="list-header">
    <h2>Students</h2>
    <p class="muted">Enrolled students and their centers</p>
  </header>

  <div class="toolbar">
    <input placeholder="Search students..." class="search" [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange($event)" />
    <div class="toolbar-actions" *ngIf="canAddMembers">
      <button class="btn-primary" type="button" (click)="openCreateStudent()">Add Student</button>
      <button class="btn-secondary" type="button" (click)="openCreateParent()">Add Parent</button>
    </div>
  </div>

  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <span>Loading students...</span>
  </div>

  <table class="list-table glass">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Center</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let s of paginatedStudents">
        <td>
          <div class="font-semibold">{{ s.name }}</div>
          <small class="muted">{{ s.phone }}</small>
        </td>
        <td>{{ s.email }}</td>
        <td>{{ s.center }}</td>
        <td>
          <button class="btn-simple" (click)="openInfo(s)">Info</button>
          <button class="btn-simple" *ngIf="canEditStudents" (click)="openEditStudent(s)">Edit</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="pagination-bar" *ngIf="filteredStudents.length">
    <div class="page-info">
      <div class="dots">
        <span class="dot" *ngFor="let i of [].constructor(totalPages); let idx = index" [class.active]="idx + 1 === page"></span>
      </div>
      <span class="muted">{{ pageStart }}–{{ pageEnd }} of {{ totalItems }}</span>
    </div>
    <div class="page-controls">
      <button type="button" class="btn-pill" [disabled]="page <= 1" (click)="goToPage(page - 1)">‹ Prev</button>
      <button type="button" class="btn-pill" [disabled]="page >= totalPages" (click)="goToPage(page + 1)">Next ›</button>
    </div>
  </div>
</section>

<div class="overlay" [class.open]="panelOpen" (click)="closeInfo()"></div>
<div class="side-panel glass" [class.open]="panelOpen" (click)="$event.stopPropagation()">
  <div class="panel-header">
    <h3>{{ panelTitle }}</h3>
    <button class="close-btn" (click)="closeInfo()">X</button>
  </div>
  <div class="panel-body" *ngIf="panelMode === 'info' && selectedStudent">
    <p><strong>Name:</strong> {{ selectedStudent.name }}</p>
    <p><strong>Email:</strong> {{ selectedStudent.email }}</p>
    <p><strong>Center:</strong> {{ selectedStudent.center || '-' }}</p>
    <p><strong>Phone:</strong> {{ selectedStudent.phone || '—' }}</p>
    <p><strong>User ID:</strong> {{ selectedStudent.id }}</p>
    <div class="panel-actions" *ngIf="canEditStudents">
      <button class="btn-primary" type="button" (click)="openEditStudent(selectedStudent)">Edit</button>
      <button class="btn-danger" type="button" (click)="deleteStudent()" [disabled]="processing">Delete</button>
    </div>
  </div>

  <div class="panel-body" *ngIf="panelMode === 'create-student' || panelMode === 'edit-student'">
    <p class="field-hint">Fields marked with * are required.</p>
    <div class="field">
      <label><span class="required">*</span>Name</label>
      <input class="input-control" type="text" [(ngModel)]="studentForm.name" placeholder="Full name"
        (ngModelChange)="onStudentInputChange()" [class.input-error]="studentErrors.name" />
      <p class="error-text" *ngIf="studentErrors.name">{{ studentErrors.name }}</p>
    </div>
    <div class="field">
      <label><span class="required">*</span>Email</label>
      <input class="input-control" type="email" [(ngModel)]="studentForm.email" placeholder="Email address"
        (ngModelChange)="onStudentInputChange()" [class.input-error]="studentErrors.email" />
      <p class="error-text" *ngIf="studentErrors.email">{{ studentErrors.email }}</p>
    </div>
    <div class="field">
      <label>Phone</label>
      <input class="input-control" type="text" [(ngModel)]="studentForm.phone" placeholder="Optional phone"
        (ngModelChange)="onStudentInputChange()" [class.input-error]="studentErrors.phone" />
      <p class="error-text" *ngIf="studentErrors.phone">{{ studentErrors.phone }}</p>
    </div>
    <div class="field" *ngIf="panelMode === 'create-student'">
      <label>Group</label>
      <input
        class="input-control"
        type="text"
        placeholder="Filter groups..."
        [(ngModel)]="groupFilter"
        style="margin-bottom: 0.5rem;"
      />
      <select class="input-control" [(ngModel)]="studentForm.groupId" (ngModelChange)="onStudentInputChange()"
        [class.input-error]="studentErrors.groupId">
        <option *ngFor="let group of filteredGroupsForSelect" [value]="group.id">
          {{ group.name }}{{ group.subject ? ' (' + group.subject + ')' : '' }}
        </option>
      </select>
      <p class="error-text" *ngIf="studentErrors.groupId">{{ studentErrors.groupId }}</p>
    </div>
    <div class="panel-actions sticky-footer">
      <button class="btn-primary" type="button" (click)="submitStudent()" [disabled]="processing || !canSubmitStudent">
        {{ panelMode === 'create-student' ? 'Create' : 'Save changes' }}
      </button>
      <button
        class="btn-danger"
        type="button"
        *ngIf="panelMode === 'edit-student'"
        (click)="deleteStudent()"
        [disabled]="processing"
      >
        Delete
      </button>
    </div>
  </div>

  <div class="panel-body" *ngIf="panelMode === 'create-parent'">
    <p class="field-hint">Fields marked with * are required.</p>
    <div class="field">
      <label><span class="required">*</span>Name</label>
      <input class="input-control" type="text" [(ngModel)]="parentForm.name" placeholder="Full name"
        (ngModelChange)="onParentInputChange()" [class.input-error]="parentErrors.name" />
      <p class="error-text" *ngIf="parentErrors.name">{{ parentErrors.name }}</p>
    </div>
    <div class="field">
      <label><span class="required">*</span>Email</label>
      <input class="input-control" type="email" [(ngModel)]="parentForm.email" placeholder="Email address"
        (ngModelChange)="onParentInputChange()" [class.input-error]="parentErrors.email" />
      <p class="error-text" *ngIf="parentErrors.email">{{ parentErrors.email }}</p>
    </div>
    <div class="field">
      <label>Phone</label>
      <input class="input-control" type="text" [(ngModel)]="parentForm.phone" placeholder="Optional phone"
        (ngModelChange)="onParentInputChange()" [class.input-error]="parentErrors.phone" />
      <p class="error-text" *ngIf="parentErrors.phone">{{ parentErrors.phone }}</p>
    </div>
    <div class="field">
      <label><span class="required">*</span>Linked student</label>
      <input
        class="input-control"
        type="text"
        placeholder="Filter students..."
        [(ngModel)]="studentFilter"
        style="margin-bottom: 0.5rem;"
      />
      <select class="input-control" [(ngModel)]="parentForm.studentId" (ngModelChange)="onParentInputChange()"
        [class.input-error]="parentErrors.studentId">
        <option *ngFor="let student of filteredStudentsForSelect" [value]="student.id">
          {{ student.name }} - {{ student.email }}
        </option>
      </select>
      <p class="error-text" *ngIf="parentErrors.studentId">{{ parentErrors.studentId }}</p>
    </div>
    <div class="panel-actions sticky-footer">
      <button class="btn-primary" type="button" (click)="submitParent()" [disabled]="processing || !canSubmitParent">Create</button>
    </div>
  </div>
</div>
